<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>szhAo's Game</title>
    <meta name="description" content="A tiny HTML5 game, made with love by szhAo.">

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" media="all" href="assets/portal.css">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <link rel="shortcut icon" href="favicon.ico" />
</head>
<body>
  <header class="site-header">
      <h1>SzhaovoGame</h1>
      <div class="auth-controls">
        <span id="userStatus" class="status">未登录</span>
        <button class="btn btn-primary" id="loginBtn">登录</button>
        <button class="btn" id="logoutBtn" style="display:none">退出</button>
      </div>
  </header>

  <main class="layout">
    <section class="game-panel card">
        <div class="game-header">
          <h2>选择游戏</h2>
          <button class="btn" id="backBtn" style="display:none">返回列表</button>
        </div>
        <div class="game-stats stats-container">
          <span class="tag">当前分数：<strong id="liveScore">0</strong></span>
          <span class="tag">历史最佳：<strong id="liveBest">0</strong></span>
          <span class="tag" id="submitStatus" style="display:none"></span>
        </div>

      <div class="game-selection">
          <div class="game-card" data-game="2048">
            <h3>2048</h3>
            <p>Join the numbers and get to the 2048 tile!</p>
          </div>
          <div class="game-card" data-game="clumsy-bird">
            <h3>Clumsy Bird</h3>
            <p>A Flappy Bird clone.</p>
          </div>
          <div class="game-card" data-game="browserquest">
            <h3>BrowserQuest</h3>
            <p>多人 HTML5 RPG（Cloudflare WebSocket）。</p>
          </div>
          <!-- Add more game cards here in the future -->
        </div>
        <div class="game-container"></div>
    </section>

    <aside class="leaderboard-panel card">
        <h3>排行榜</h3>
      <ol id="leaderboard" class="leaderboard"></ol>
      <div class="alert" id="lbAlert" style="display:none"></div>
    </aside>
  </main>

  <footer class="site-footer">
    <small>页面集成示例：Cloudflare Workers 认证与分数上报 · D1 排行榜</small>
  </footer>

  <script src="sdk/game_sdk.js"></script>
  <script>
    const gameSelection = document.querySelector('.game-selection');
    const gameContainer = document.querySelector('.game-container');
    let sdk;

    // Auth-only SDK initialization on page load
    sdk = new GameSDK({});

    document.querySelectorAll('.game-card').forEach(card => {
      card.addEventListener('click', () => {
        const gameKey = card.dataset.game;
        // Require login for BrowserQuest
        const requiresLogin = gameKey === 'browserquest';
        if (requiresLogin) {
          const hasToken = sdk && typeof sdk.getToken === 'function' ? !!sdk.getToken() : false;
          if (!hasToken) {
            const alertBox = document.getElementById('lbAlert');
            if (alertBox) {
              alertBox.textContent = '此游戏需要登录后游玩，请先点击右上角“登录”。';
              alertBox.style.display = 'block';
            }
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) loginBtn.focus();
            return;
          }
        }
        loadGame(gameKey);
      });
    });

    document.getElementById('backBtn').addEventListener('click', () => {
      window.location.reload();
    });

    const GAME_MAP = {
      '2048': { path: 'games/2048/index.html', title: '2048' },
      'clumsy-bird': { path: 'games/clumsy-bird/index.html', title: 'Clumsy Bird' },
      // BrowserQuest 客户端入口位于 client/index.html
      'browserquest': { path: 'games/BrowserQuest-client/client/index.html', title: 'BrowserQuest' },
    };

    function loadGame(gameKey) {
      // Hide game selection and show game view
      gameSelection.style.display = 'none';
      document.querySelector('.game-container').style.display = 'block';
      document.getElementById('backBtn').style.display = 'block';

      // Toggle fullscreen mode for BrowserQuest
      const isFullscreen = gameKey === 'browserquest';
      document.body.classList.toggle('fullscreen-game', isFullscreen);

      // Clear previous game
      gameContainer.innerHTML = '';

      // Create and load new game iframe
      const iframe = document.createElement('iframe');
      iframe.id = 'gameFrame';
      const game = GAME_MAP[gameKey];
      iframe.src = game ? game.path : `games/${gameKey}/index.html`;
      iframe.title = gameKey;
      iframe.classList.add('game-frame');
      iframe.loading = 'eager';
      gameContainer.appendChild(iframe);

      // Initialize SDK for the selected game
      if (sdk) {
        // If we have a previous SDK instance, we might need to clean it up
        // For now, we'll just create a new one.
      }
      sdk = new GameSDK({
        gameKey: gameKey,
      });

      // Update titles
      const title = game ? game.title : gameKey;
      document.querySelector('.game-panel h2').textContent = title;
      document.querySelector('.leaderboard-panel h3').textContent = `排行榜（${gameKey}）`;
    }
  </script>
</body>
</html>